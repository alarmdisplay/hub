---
kind: pipeline
type: docker
name: compliance

trigger:
  branch:
    include:
      - develop
      - main

steps:
  - name: lint-server
    image: node:20.13.0
    commands:
      - cd server
      - npm ci
      - npm run lint
  - name: lint-console
    image: node:20.13.0
    commands:
      - cd console
      - npm ci
      - npm run lint

---
kind: pipeline
type: docker
name: testing-linux-amd64

platform:
  os: linux
  arch: amd64

trigger:
  branch:
    include:
      - develop
      - main

depends_on:
  - compliance

steps:
  - name: test-server-node-18
    image: node:18.19.1
    commands:
      - cd server
      - npm ci
      - npx jest --runInBand --forceExit
  - name: test-server-node-20
    image: node:20.13.0
    environment:
      CC_TEST_REPORTER_ID:
        from_secret: cc_test_reporter_id
    commands:
      - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
      - chmod +x ./cc-test-reporter
      - ./cc-test-reporter before-build
      - cd server
      - npm ci
      - npx jest --runInBand --forceExit --coverage
      - ../scripts/report-code-coverage.sh
  - name: codecov
    image: alpine:3.19.1
    environment:
      CODECOV_TOKEN:
        from_secret: codecov_token
    commands:
      - apk add curl gnupg coreutils git
      - curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --no-default-keyring --keyring /root/trustedkeys.gpg --import
      - curl -Os https://cli.codecov.io/latest/alpine/codecov
      - curl -Os https://cli.codecov.io/latest/alpine/codecov.SHA256SUM
      - curl -Os https://cli.codecov.io/latest/alpine/codecov.SHA256SUM.sig
      - gpgv --keyring /root/trustedkeys.gpg codecov.SHA256SUM.sig codecov.SHA256SUM
      - sha256sum -c codecov.SHA256SUM
      - chmod +x codecov
      - ./codecov --file server/coverage/lcov.info --flags server
---
kind: signature
hmac: 20253b450eac3e19c6a8a699be13ed51767344b6c4a5687b2eed003cbaced1a0

...
